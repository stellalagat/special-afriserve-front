<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Profile - Africonnect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base Variables */
        :root {
            --primary: #FF6B00;
            --primary-dark: #E55A00;
            --secondary: #00A859;
            --dark: #2C3E50;
            --light: #F5F7FA;
            --accent: #FFD166;
            --text: #2C3E50;
            --bg: #F5F7FA;
            --card-bg: #FFFFFF;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --radius: 12px;
            --glow: 0 0 20px rgba(255, 107, 0, 0.3);
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Exo 2', sans-serif;
        }

        body {
            color: var(--text);
            line-height: 1.6;
            background-color: var(--bg);
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .logo-icon {
            font-size: 3rem;
            color: var(--primary);
        }

        .logo h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header h2 {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.8;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Role Selection */
        .role-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .role-card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .role-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 107, 0, 0.1), transparent);
            transition: 0.5s;
        }

        .role-card:hover:before {
            left: 100%;
        }

        .role-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .role-card.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--card-bg), rgba(255, 107, 0, 0.05));
            box-shadow: var(--glow);
        }

        .role-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 20px;
            display: block;
        }

        .role-card h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .role-card p {
            margin-bottom: 20px;
            opacity: 0.8;
        }

        .benefits-list {
            text-align: left;
            margin-top: 20px;
        }

        .benefits-list li {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .benefits-list i {
            color: var(--secondary);
            font-size: 0.8rem;
        }

        /* Profile Form */
        .profile-form-container {
            display: none;
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 40px;
            margin-top: 30px;
        }

        .profile-form-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .form-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .form-header h3 {
            font-size: 1.8rem;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .form-header p {
            opacity: 0.8;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h4 {
            font-size: 1.3rem;
            color: var(--dark);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: var(--bg);
            color: var(--text);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 0, 0.3);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--dark);
            border: 2px solid rgba(0,0,0,0.1);
        }

        .btn-secondary:hover {
            background-color: rgba(0,0,0,0.05);
            border-color: rgba(0,0,0,0.2);
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 107, 0, 0.3);
            border-left: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .role-selection {
                grid-template-columns: 1fr;
            }
            
            .profile-form-container {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
        }

        /* Success Message */
        .success-message {
            display: none;
            text-align: center;
            padding: 40px;
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .success-message i {
            font-size: 4rem;
            color: var(--secondary);
            margin-bottom: 20px;
        }

        .success-message h3 {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .unique-id {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 30px;
            border-radius: var(--radius);
            font-size: 1.5rem;
            font-weight: 600;
            margin: 20px 0;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Role Selection Section -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-hands-helping logo-icon"></i>
                <h1>Africonnect</h1>
            </div>
            <h2>Choose Your Role</h2>
            <p>Select how you'd like to use Africonnect. Your choice will determine the features available to you.</p>
        </div>

        <div class="role-selection" id="roleSelection">
            <!-- Role cards will be populated by JavaScript -->
        </div>

        <!-- Profile Form Section -->
        <div class="profile-form-container" id="profileForm">
            <div class="form-header">
                <h3 id="formTitle">Complete Your Profile</h3>
                <p id="formDescription">Fill in your details to get started</p>
            </div>
            
            <form id="profileFormElement">
                <!-- Form content will be populated by JavaScript based on role -->
                <div id="formContent"></div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="backToRoles">
                        <i class="fas fa-arrow-left"></i> Back to Roles
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Complete Profile
                    </button>
                </div>
            </form>
        </div>

        <!-- Loading Section -->
        <div class="loading" id="loadingSection">
            <div class="spinner"></div>
            <p>Processing your information...</p>
        </div>

        <!-- Success Section -->
        <div class="success-message" id="successSection">
            <i class="fas fa-check-circle"></i>
            <h3>Profile Completed Successfully!</h3>
            <p>Your profile has been created and you're ready to start using Africonnect.</p>
            <div class="unique-id" id="uniqueIdDisplay"></div>
            <p>Your unique ID will be used for all your transactions and bookings.</p>
            <button class="btn btn-primary" id="goToDashboard">
                <i class="fas fa-tachometer-alt"></i> Go to Dashboard
            </button>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = 'http://localhost:3000/api';
        let selectedRole = null;
        let authToken = localStorage.getItem('authToken');

        // Check if user is authenticated
        if (!authToken) {
            window.location.href = 'login.html';
        }

        // Role data with detailed information
        const roles = [
            {
                id: 'Customer',
                name: 'Customer',
                description: 'Find and book services from trusted local businesses',
                icon: 'fas fa-user',
                benefits: [
                    'Book services easily',
                    'Track your bookings',
                    'Get special offers',
                    'Rate service providers'
                ],
                formFields: {
                    basic: [
                        { name: 'dateOfBirth', label: 'Date of Birth', type: 'date', required: true },
                        { name: 'gender', label: 'Gender', type: 'select', options: ['Male', 'Female', 'Other'], required: true }
                    ],
                    address: [
                        { name: 'address.street', label: 'Street Address', type: 'text', required: true },
                        { name: 'address.city', label: 'City', type: 'text', required: true },
                        { name: 'address.state', label: 'State/Province', type: 'text', required: true },
                        { name: 'address.zipCode', label: 'ZIP/Postal Code', type: 'text', required: true }
                    ]
                }
            },
            {
                id: 'BusinessOwner',
                name: 'Business Owner',
                description: 'Grow your business by reaching new customers',
                icon: 'fas fa-store',
                benefits: [
                    'Manage your business profile',
                    'Receive customer bookings',
                    'Promote your services',
                    'Track business analytics'
                ],
                formFields: {
                    business: [
                        { name: 'businessName', label: 'Business Name', type: 'text', required: true },
                        { name: 'businessType', label: 'Business Type', type: 'select', 
                          options: ['Retail', 'Service', 'Manufacturing', 'Food', 'Healthcare', 'Education', 'Other'], required: true },
                        { name: 'registrationNumber', label: 'Registration Number', type: 'text', required: true },
                        { name: 'taxId', label: 'Tax ID (Optional)', type: 'text', required: false }
                    ],
                    details: [
                        { name: 'yearEstablished', label: 'Year Established', type: 'number', required: true },
                        { name: 'numberOfEmployees', label: 'Number of Employees', type: 'select',
                          options: ['1-10', '11-50', '51-200', '201-500', '500+'], required: true },
                        { name: 'businessDescription', label: 'Business Description', type: 'textarea', required: true }
                    ],
                    address: [
                        { name: 'businessAddress.street', label: 'Business Address', type: 'text', required: true },
                        { name: 'businessAddress.city', label: 'City', type: 'text', required: true },
                        { name: 'businessAddress.state', label: 'State', type: 'text', required: true },
                        { name: 'businessAddress.zipCode', label: 'ZIP Code', type: 'text', required: true }
                    ],
                    contact: [
                        { name: 'contactPerson.name', label: 'Contact Person Name', type: 'text', required: true },
                        { name: 'contactPerson.position', label: 'Position', type: 'text', required: true },
                        { name: 'contactPerson.phone', label: 'Contact Phone', type: 'tel', required: true },
                        { name: 'contactPerson.email', label: 'Contact Email', type: 'email', required: true }
                    ]
                }
            },
            {
                id: 'ServiceProvider',
                name: 'Service Provider',
                description: 'Offer your skills and services to customers',
                icon: 'fas fa-tools',
                benefits: [
                    'Showcase your skills',
                    'Get hired by customers',
                    'Build your reputation',
                    'Manage your schedule'
                ],
                formFields: {
                    professional: [
                        { name: 'professionalTitle', label: 'Professional Title', type: 'text', required: true },
                        { name: 'specialization', label: 'Specialization', type: 'text', required: true },
                        { name: 'yearsOfExperience', label: 'Years of Experience', type: 'number', required: true },
                        { name: 'skills', label: 'Skills (comma separated)', type: 'text', required: true }
                    ],
                    qualifications: [
                        { name: 'qualifications[0].institution', label: 'Institution', type: 'text', required: true },
                        { name: 'qualifications[0].qualification', label: 'Qualification', type: 'text', required: true },
                        { name: 'qualifications[0].year', label: 'Year', type: 'number', required: true },
                        { name: 'qualifications[0].field', label: 'Field of Study', type: 'text', required: true }
                    ],
                    availability: [
                        { name: 'hourlyRate', label: 'Hourly Rate (ZAR)', type: 'number', required: true },
                        { name: 'travelRadius', label: 'Travel Radius (km)', type: 'number', required: true },
                        { name: 'languages', label: 'Languages (comma separated)', type: 'text', required: true }
                    ]
                }
            },
            {
                id: 'Wholesaler',
                name: 'Wholesaler',
                description: 'Connect with businesses and service providers',
                icon: 'fas fa-boxes',
                benefits: [
                    'Reach business customers',
                    'Manage product catalog',
                    'Process bulk orders',
                    'Build B2B relationships'
                ],
                formFields: {
                    company: [
                        { name: 'companyName', label: 'Company Name', type: 'text', required: true },
                        { name: 'businessType', label: 'Business Type', type: 'select',
                          options: ['Manufacturer', 'Distributor', 'Supplier', 'Importer', 'Exporter'], required: true },
                        { name: 'registrationNumber', label: 'Registration Number', type: 'text', required: true },
                        { name: 'vatNumber', label: 'VAT Number', type: 'text', required: true }
                    ],
                    operations: [
                        { name: 'yearEstablished', label: 'Year Established', type: 'number', required: true },
                        { name: 'companySize', label: 'Company Size', type: 'select',
                          options: ['Small (1-50)', 'Medium (51-200)', 'Large (201-1000)', 'Enterprise (1000+)'], required: true },
                        { name: 'minimumOrder', label: 'Minimum Order Value (ZAR)', type: 'number', required: true },
                        { name: 'paymentTerms', label: 'Payment Terms', type: 'text', required: true }
                    ],
                    products: [
                        { name: 'productCategories', label: 'Product Categories (comma separated)', type: 'text', required: true },
                        { name: 'brandsCarried', label: 'Brands Carried (comma separated)', type: 'text', required: true },
                        { name: 'qualityStandards', label: 'Quality Standards (comma separated)', type: 'text', required: true }
                    ]
                }
            }
        ];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            renderRoleCards();
            setupEventListeners();
            checkExistingProfile();
        });

        // Render role selection cards
        function renderRoleCards() {
            const roleSelection = document.getElementById('roleSelection');
            
            roles.forEach(role => {
                const roleCard = document.createElement('div');
                roleCard.className = 'role-card';
                roleCard.dataset.role = role.id;
                
                roleCard.innerHTML = `
                    <i class="${role.icon} role-icon"></i>
                    <h3>${role.name}</h3>
                    <p>${role.description}</p>
                    <ul class="benefits-list">
                        ${role.benefits.map(benefit => `<li><i class="fas fa-check"></i> ${benefit}</li>`).join('')}
                    </ul>
                `;
                
                roleSelection.appendChild(roleCard);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Role selection
            document.querySelectorAll('.role-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectRole(this.dataset.role);
                });
            });

            // Back to roles button
            document.getElementById('backToRoles').addEventListener('click', function() {
                showRoleSelection();
            });

            // Form submission
            document.getElementById('profileFormElement').addEventListener('submit', function(e) {
                e.preventDefault();
                submitProfileForm();
            });

            // Go to dashboard
            document.getElementById('goToDashboard').addEventListener('click', function() {
                window.location.href = 'dashboard.html';
            });
        }

        // Check if user already has a profile
        function checkExistingProfile() {
            fetch(`${API_BASE}/profile`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.user.profileCompleted) {
                    // User already has a profile, redirect to dashboard
                    window.location.href = 'dashboard.html';
                }
            })
            .catch(error => {
                console.error('Error checking profile:', error);
            });
        }

        // Select a role
        function selectRole(roleId) {
            selectedRole = roles.find(role => role.id === roleId);
            
            // Update UI
            document.querySelectorAll('.role-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-role="${roleId}"]`).classList.add('selected');
            
            // Show profile form
            showProfileForm();
        }

        // Show role selection
        function showRoleSelection() {
            document.getElementById('roleSelection').style.display = 'grid';
            document.getElementById('profileForm').classList.remove('active');
            document.getElementById('successSection').style.display = 'none';
        }

        // Show profile form
        function showProfileForm() {
            document.getElementById('roleSelection').style.display = 'none';
            document.getElementById('profileForm').classList.add('active');
            document.getElementById('successSection').style.display = 'none';
            
            // Update form title and description
            document.getElementById('formTitle').textContent = `Complete Your ${selectedRole.name} Profile`;
            document.getElementById('formDescription').textContent = `Tell us more about yourself as a ${selectedRole.name.toLowerCase()}`;
            
            // Render form fields
            renderFormFields();
        }

        // Render form fields based on selected role
        function renderFormFields() {
            const formContent = document.getElementById('formContent');
            formContent.innerHTML = '';
            
            Object.keys(selectedRole.formFields).forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'form-section';
                
                const sectionTitle = document.createElement('h4');
                sectionTitle.textContent = section.charAt(0).toUpperCase() + section.slice(1) + ' Information';
                sectionDiv.appendChild(sectionTitle);
                
                const sectionGrid = document.createElement('div');
                sectionGrid.className = 'form-grid';
                
                selectedRole.formFields[section].forEach(field => {
                    const formGroup = document.createElement('div');
                    formGroup.className = 'form-group';
                    
                    const label = document.createElement('label');
                    label.textContent = field.label;
                    if (field.required) label.innerHTML += ' <span style="color: red;">*</span>';
                    formGroup.appendChild(label);
                    
                    let input;
                    if (field.type === 'select') {
                        input = document.createElement('select');
                        input.className = 'form-control';
                        input.name = field.name;
                        input.required = field.required || false;
                        
                        field.options.forEach(option => {
                            const optionElement = document.createElement('option');
                            optionElement.value = option;
                            optionElement.textContent = option;
                            input.appendChild(optionElement);
                        });
                    } else if (field.type === 'textarea') {
                        input = document.createElement('textarea');
                        input.className = 'form-control';
                        input.name = field.name;
                        input.rows = 4;
                        input.required = field.required || false;
                    } else {
                        input = document.createElement('input');
                        input.type = field.type;
                        input.className = 'form-control';
                        input.name = field.name;
                        input.required = field.required || false;
                    }
                    
                    formGroup.appendChild(input);
                    sectionGrid.appendChild(formGroup);
                });
                
                sectionDiv.appendChild(sectionGrid);
                formContent.appendChild(sectionDiv);
            });

            // Add business initials and number for specific roles
            if (['BusinessOwner', 'Wholesaler'].includes(selectedRole.id)) {
                const customSection = document.createElement('div');
                customSection.className = 'form-section';
                
                customSection.innerHTML = `
                    <h4>Unique ID Configuration</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Business Initials (2-3 letters) *</label>
                            <input type="text" class="form-control" name="businessInitials" maxlength="3" required 
                                   placeholder="e.g., ABC">
                        </div>
                        <div class="form-group">
                            <label>Your Chosen Number (4 digits) *</label>
                            <input type="number" class="form-control" name="userChosenNumber" min="0" max="9999" required 
                                   placeholder="e.g., 1234">
                        </div>
                    </div>
                `;
                
                formContent.appendChild(customSection);
            }
        }

        // Submit profile form
        function submitProfileForm() {
            const formData = new FormData(document.getElementById('profileFormElement'));
            const profileData = {};
            let businessInitials = null;
            let userChosenNumber = null;

            // Convert form data to object
            for (let [key, value] of formData.entries()) {
                if (key === 'businessInitials') {
                    businessInitials = value;
                    continue;
                }
                if (key === 'userChosenNumber') {
                    userChosenNumber = parseInt(value);
                    continue;
                }
                
                // Handle nested properties
                if (key.includes('.')) {
                    const keys = key.split('.');
                    let current = profileData;
                    for (let i = 0; i < keys.length - 1; i++) {
                        if (!current[keys[i]]) current[keys[i]] = {};
                        current = current[keys[i]];
                    }
                    current[keys[keys.length - 1]] = value;
                } else if (key.includes('[')) {
                    // Handle array properties
                    const match = key.match(/(\w+)\[(\d+)\]\.(\w+)/);
                    if (match) {
                        const [, arrayName, index, prop] = match;
                        if (!profileData[arrayName]) profileData[arrayName] = [];
                        if (!profileData[arrayName][index]) profileData[arrayName][index] = {};
                        profileData[arrayName][index][prop] = value;
                    }
                } else {
                    profileData[key] = value;
                }
            }

            // Show loading
            document.getElementById('profileForm').classList.remove('active');
            document.getElementById('loadingSection').style.display = 'block';

            // Submit to API
            fetch(`${API_BASE}/complete-profile`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    role: selectedRole.id,
                    profileData: profileData,
                    businessInitials: businessInitials,
                    userChosenNumber: userChosenNumber
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess(data.user.uniqueId);
                    // Update token in localStorage
                    localStorage.setItem('authToken', data.token);
                } else {
                    throw new Error(data.message || 'Failed to complete profile');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error completing profile: ' + error.message);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('profileForm').classList.add('active');
            });
        }

        // Show success message
        function showSuccess(uniqueId) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('successSection').style.display = 'block';
            document.getElementById('uniqueIdDisplay').textContent = uniqueId;
        }
    </script>
</body>
</html>